# Orval 質問・振り返りまとめ（詳細版）

## 1. Orval の概念

- **OpenAPI から TypeScript の API 呼び出しコードを自動生成するツール**
- 主に以下を自動化:
  - axios を用いた API リクエスト関数
  - React Query の useQuery / useMutation Hook
  - queryKey の自動生成・管理
  - 型安全なパラメータ・レスポンス

- 生成コードは「画面単位での API 利用」を想定
- 従来の手書き Hook (`useInitialQuery`) は原則不要

## 2. 導入手順

1. インストール

```bash
npm install -D orval
```

2. 設定ファイル作成（`orval.config.ts`）

```ts
import { defineConfig } from "orval";
export default defineConfig({
  api: {
    input: "./api-spec.json",
    output: {
      target: "./openApi/autoGenerated",
      client: "react-query",
      mode: "tags",
      override: {
        query: { useQuery: true, useMutation: true },
        mutator: { path: "./lib/axios.ts", name: "apiClient" },
      },
    },
  },
});
```

3. package.json に scripts 追加

```json
"scripts": {
  "orval": "orval"
}
```

4. 実行

```bash
npm run orval
```

## 3. axios と mutator の関係

- `axiosInstance`: 共通設定（baseURL, withCredentials）や interceptor を持つ「実体」
- `apiClient`: orval が呼ぶ関数。axiosInstance を内部で利用
- 返却型は `Promise<AxiosResponse<T>>` が推奨
- 命名は逆でも動くが、責務を分ける今の命名が推奨
- interceptor でのエラーハンドリング、ログ出力、リダイレクト処理は axiosInstance 側で管理

## 4. 生成された Hook の使い方

### useQuery (例: useInit)

```ts
const { data, isFetching, refetch, queryKey } = useInit(
  params,
  { query: { enabled: true, staleTime: 5000 } },
  queryClient
);
```

- queryKey は自動生成される (`getInitQueryKey`)。
- options で `enabled` や `staleTime`、`initialData` を調整可能。
- mutation 後のデータ更新は `queryClient.invalidateQueries(getInitQueryKey(params))` で管理

### useMutation (例: useToroku, useSakujo)

```ts
const mutation = useToroku({
  mutation: {
    onSuccess: () => queryClient.invalidateQueries(getInitQueryKey(params)),
  },
});
```

- mutationKey は自動生成される
- options で onSuccess, onError などの挙動をカスタマイズ可能

## 5. OpenAPI における summary / description / operationId

### summary

- API の一覧表示用の短い説明（1行）
- Swagger UI やドキュメント左ペインに表示される
- Hook 名の元にならないが、簡単に API の目的を伝える

### description

- 詳細な API 説明、業務ルール、注意点を記述
- 複数行、Markdown 可
- summary と重複するだけなら省略可
- 書くとチームメンバーやフロントエンド側が利用しやすくなる

### operationId

- Hook 名や関数名の元になる一意の識別子
- 画面単位ではなく API 単位で設計される
- 画面側で useInit / useToroku のように呼び出す際の基準

## 6. description / summary の活用方針

- summary: **必須**、短く1行で何をする API か示す
- description: **補足がある場合のみ記載**
  - 部分一致検索の挙動、権限制御、パラメータ制約など
  - 書かない場合は summary の情報だけで十分

- チーム運用ルールとして「summary = 見出し」「description = 本文」と区別すると理解しやすい

## 7. 振り返りポイント

- 自作 Hook は orval Hook に置き換え可能
- axios interceptor と orval mutator は分離して管理
- queryKey は自動生成されるので、画面設計に合わせて作る必要はない
- operationId / tag 名で Hook 名が決まるので、必要に応じて OpenAPI を修正して命名を統一
- description は必要な場合のみ記載
- package.json の scripts で `npm run orval` を管理可能
- React Query の options を調整することで画面ごとの細かい挙動を制御可能
