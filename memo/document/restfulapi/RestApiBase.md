# REST API 概要

読みやすさと用語の統一を優先して再構成しました。必要に応じて社内向けの補足を追記してください。

## 目次

- [はじめに](#はじめに)
- [背景と設計姿勢](#背景と設計姿勢)
- [基本概念](#基本概念)
- [サンプル: GET /users](#サンプル-get-users)
- [レスポンス設計](#レスポンス設計)
- [REST API の特性](#rest-api-の特性)
- [REST の設計原則](#rest-の設計原則)
- [REST API 成熟モデル](#rest-api-成熟モデル)
- [URI 設計ガイド](#uri-設計ガイド)
- [大量アクセス制御](#大量アクセス制御)
- [レートリミットの代表的手法](#レートリミットの代表的手法)
- [API 脆弱性対策](#api-脆弱性対策)
- [チェックリスト](#チェックリスト)
- [OpenAPI と Swagger](#openapi-と-swagger)

## はじめに

REST API（Representational State Transfer API）は、HTTP を使ってリソースの状態を表現・操作するアーキテクチャスタイル。HTTP メソッド（GET/POST/PUT/DELETE など）でリソースの取得・作成・更新・削除を行う。

## 背景と設計姿勢

- 普及背景: Amazon アフィリエイト API、Twitter API による Bot エコシステムなどで一般化。
- API エコノミー: 公開して外部と連携する流れ。海外は公開志向、日本はリスク回避傾向。
- 開発者セット: LSUDS（公開 API）と SSKDS（社内限定）では求める UX/ガバナンスが変わる。
- 美しい API の条件: 使いやすい・変更しやすい・頑強・恥ずかしくない。ベストプラクティスの理由も理解して採用する。

## 基本概念

- **リソース**: API が扱う対象。URI で一意に識別される。
- **HTTP メソッド**:
  - GET: 取得（読み取り専用）
  - POST: 作成
  - PUT: 全体更新（冪等）
  - PATCH: 部分更新（非冪等の場合あり）
  - DELETE: 削除（冪等）
- **ステートレス**: 各リクエストは独立。サーバーはクライアント状態を保持しない。
- **URI 例**: `/users`（コレクション）、`/users/{id}`（特定リソース）。
- **レスポンスとステータスコード例**:
  - 200 OK（成功）
  - 201 Created（作成完了）
  - 202 Accepted（非同期受付）
  - 204 No Content（本文なし）
  - 400 Bad Request（リクエスト不正）
  - 401 Unauthorized（認証必要）
  - 404 Not Found（未検出）
  - 500 Internal Server Error（サーバーエラー）

## サンプル: GET /users

全ユーザーを取得する例。

リクエスト

```
GET /users HTTP/1.1
Host: example.com
```

レスポンス（例）

```json
[
  { "id": 1, "name": "John Doe", "email": "john.doe@example.com" },
  { "id": 2, "name": "Jane Smith", "email": "jane.smith@example.com" }
]
```

## レスポンス設計

- API は DB IF ではなくアプリ IF。ユースケースに沿い往復回数を抑える。
- フィールド選択: クライアントが返却フィールドを指定できるようにする（省略時は全件）。
- 配列レスポンス: 先頭が配列のみだと JSON ハイジャック懸念があるためオブジェクトでラップするなど対策を検討。
- データ命名: 一般的な単語を使い、省略形を避け、連結ルールと単複を統一。
- BigInt 取り扱い: JS の `number` は 53bit が上限。DB の BIGINT は文字列で返すなど安全に扱う。

## REST API の特性

- **副作用**: データが変更される操作（POST/PUT/PATCH/DELETE など）。
- **安全性（Safe）**: 副作用を持たない操作。GET は安全。
- **冪等性（Idempotent）**: 同じリクエストを複数回実行しても結果が変わらない。GET/PUT/DELETE は冪等、POST は通常非冪等。

## REST の設計原則

- **クライアント/サーバ**: 役割分離。クライアントは要求、サーバは応答。
- **ステートレス**: サーバ側でセッション状態を持たない。
- **キャッシュ制御**: HTTP キャッシュで効率化。
- **統一インターフェイス**: 一貫した URI とメソッド、表現形式を採用。
- **階層化システム**: 多層構造で疎結合にする（例: API Gateway, BFF）。
- **コードオンデマンド（任意）**: 必要に応じクライアントへコード配布。

## REST API 成熟モデル

- **Level 0**: 単一エンドポイントで操作を分岐（ただの HTTP 通信）。
- **Level 1**: リソースごとに URI を分離。
- **Level 2**: HTTP メソッドとステータスコードを適切に活用（CRUD）。
- **Level 3**: HATEOAS を導入し、レスポンスに遷移リンクを含める。

## URI 設計ガイド

- 短く、入力しやすく、覚えやすい。
- 人が読んで意味がわかる名前を使う（省略語を避ける）。
- 大文字・小文字を混在させない（小文字に統一）。
- 単語はハイフンで連結し、コレクションは複数形にする（`/users`）。
- エンコードが必要な文字や意味不明な文字列を避ける。
- サーバー内部の構造を URI に出さない。
- ルールを統一し、クエリ/パスパラメータの命名も一貫させる。
  - クエリパラメータ: オプション指定や検索条件に利用。
  - パスパラメータ: 一意なリソース識別に利用。
- ページネーションは `offset/limit` などの絶対位置で返すとズレにくい。必要に応じ HATEOAS でページリンクを返す。

## 大量アクセス制御

- API 公開に伴う過負荷対策としてレートリミットを設ける。
- 設計時に検討すること:
  - 対象: API キー単位か、ユーザー ID 単位か。
  - 範囲: 単一エンドポイントか、API 全体か。
  - 上限回数: 例) 10 回/10 分、100 回/1 時間 など。
  - 単位時間: 10 分、1 時間、1 日など。

## レートリミットの代表的手法

- **Fixed Window**: 時間枠ごとにカウントをリセット。実装が簡単だが境界付近の集中に弱い。
- **Sliding Log**: 過去一定期間のリクエストログを参照。精度は高いがログが増えやすい。
- **Sliding Window**: Fixed と Sliding Log の折衷。精度とコストのバランスが良い。

## API 脆弱性対策

- **XSS**: スクリプト混入による情報窃取・改ざん。
  - 出力エスケープ、Content-Security-Policy 等で防御。
- **CSRF**: 不正な送信を利用する攻撃。
  - オリジン/リファラ検証、CSRF トークン発行、SameSite Cookie。
- **HTTPS 未利用**: 平文通信で盗聴・改ざんされやすい。
  - TLS を使用し HTTPS を必須化。
- **JWT 誤用**: `alg` に `none` を許可するなどの設定不備。
  - 署名を必須化し、適切なアルゴリズムを強制。
- **セキュリティヘッダ**: `X-Content-Type-Options: nosniff` で MIME スニッフィングを防止。CSP などと併用。

## チェックリスト

- URI: 短く読みやすい／小文字統一／ハイフン連結／複数形／内部構造を露出しない／スペースやエンコード必須文字なし。
- HTTP メソッド: 処理内容に合った動詞か（GET/POST/PUT/PATCH/DELETE）。
- 用語: API で一般的な単語を選べているか。
- ページネーション: 設計が適切か（`offset/limit` 等）。必要なら HATEOAS でリンクを返すか。
- 認証: ログインに OAuth 2.0 を利用しているか。
- レスポンス形式: JSON をデフォルトにし、不要な JSONP を許可していないか。フィールド選択を許可するか。
- レスポンス構造: 不要なエンベロープなし／できるだけフラット／配列直返しを避けるか。
- データ命名: 一般的な単語・少語数・連結方法統一・省略形なし・単複一致。
- エラー: 原因切り分け可能な情報か／HTML を返していないか／ステータスコードが適切か／メンテ時は 503 を返すか。
- ヘッダ: 適切なメディアタイプ、CORS 必要時は対応、Cache-Control/ETag/Last-Modified/Vary を適用。`no-cache` の要否を検討。
- バージョン: セマンティックバージョニングを採用し、メジャー番号を URI に含めるか。提供終了ポリシーを明記するか。
- セキュリティ: HTTPS、JSON エスケープ、`X-Requested-With` などで SCRIPT 読み込み対策、CSRF トークン。
- バリデーション: 受信パラメータの不正値チェック、再送での二重更新防止。
- レートリミット: 実装の有無と上限がユースケースに対して妥当か。

## OpenAPI と Swagger

- **OpenAPI**: REST API を JSON/YAML で記述する標準仕様（OAS）。
- **Swagger ツール群**: OpenAPI を扱うためのツール。
  - Swagger Editor（編集）、Swagger Codegen（コード生成）、Swagger UI（ドキュメント表示）。
